name: Deploy to Linux EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci

  deploy:
    needs: test
    runs-on: self-hosted  # This runs on YOUR Linux Server
    if: github.ref == 'refs/heads/main'
    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      VITE_API_TIMEOUT: ${{ secrets.VITE_API_TIMEOUT }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DEFAULT_PASSWORD: ${{ secrets.DEFAULT_PASSWORD }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
      FRONTENDPASSWORD_RESET_EXPIRATION_MINUTES_URL: ${{ secrets.PASSWORD_RESET_EXPIRATION_MINUTES }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
      GOOGLE_WORKSPACE_DOMAIN: ${{ secrets.GOOGLE_WORKSPACE_DOMAIN }}
      GOOGLE_CALENDAR_ID: ${{ secrets.GOOGLE_CALENDAR_ID }}
      GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to Linux Server
      run: |
        echo "Starting deployment..."
        set -x  # Enable debug mode to show all commands
        
        cd /home/ec2-user/mentalspace-ehr
        
        # Check if directory exists and is a git repository
        if [ ! -d ".git" ]; then
          echo "Git repository not found. Cleaning directory and cloning from GitHub..."
          rm -rf /home/ec2-user/mentalspace-ehr/*
          rm -rf /home/ec2-user/mentalspace-ehr/.* 2>/dev/null || true
          git clone https://github.com/Yi-Jacob/mentalspace-ehr.git .
        else
          echo "Git repository found. Pulling latest changes..."
          git pull origin main
        fi
        
        # Create frontend .env file (no secrets)
        echo "Creating frontend .env file..."
        echo "VITE_API_URL=http://3.147.75.218:7000/api" > apps/frontend/.env
        echo "VITE_API_TIMEOUT=${VITE_API_TIMEOUT}" >> apps/frontend/.env
        chmod 600 apps/frontend/.env
        
        # Create backend .env file (with secrets)
        echo "Creating backend .env file..."
        echo "NODE_ENV=production" > apps/backend/.env
        echo "DATABASE_URL=${DATABASE_URL}" >> apps/backend/.env
        echo "JWT_SECRET=${JWT_SECRET}" >> apps/backend/.env
        echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> apps/backend/.env
        echo "DEFAULT_PASSWORD=${DEFAULT_PASSWORD}" >> apps/backend/.env
        echo "EMAIL_FROM=${EMAIL_FROM}" >> apps/backend/.env
        echo "FRONTEND_URL=${FRONTEND_URL}" >> apps/backend/.env
        echo "FRONTENDPASSWORD_RESET_EXPIRATION_MINUTES_URL=${FRONTENDPASSWORD_RESET_EXPIRATION_MINUTES_URL}" >> apps/backend/.env
        echo "RESEND_API_KEY=${RESEND_API_KEY}" >> apps/backend/.env
        echo "AWS_REGION=${AWS_REGION}" >> apps/backend/.env
        echo "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" >> apps/backend/.env
        echo "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" >> apps/backend/.env
        echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> apps/backend/.env
        echo "GOOGLE_WORKSPACE_DOMAIN=${GOOGLE_WORKSPACE_DOMAIN}" >> apps/backend/.env
        echo "GOOGLE_CALENDAR_ID=${GOOGLE_CALENDAR_ID}" >> apps/backend/.env
        echo "JWT_EXPIRES_IN=24h" >> apps/backend/.env
        echo "PORT=7000" >> apps/backend/.env
        chmod 600 apps/backend/.env
        
        # Create Google service account JSON file
        echo "Creating Google service account JSON file..."
        mkdir -p apps/backend/config
        echo "${GOOGLE_SERVICE_ACCOUNT}" > apps/backend/config/google-service-account.json
        chmod 600 apps/backend/config/google-service-account.json
        
        echo "Stopping existing containers..."
        docker-compose down --remove-orphans
        
        echo "Building and starting containers..."
        docker-compose up -d --build
        
        echo "Waiting for containers to start..."
        sleep 30
        
        echo "Checking container status..."
        docker ps -a
        
        echo "Checking backend logs (last 100 lines)..."
        docker logs mentalspace-backend --tail=100 || echo "Backend container not found"
        
        echo "Checking backend exit code..."
        docker inspect mentalspace-backend --format='{{.State.ExitCode}}' || echo "Container not found"
        
        echo "Checking all container logs..."
        docker-compose logs --tail=100
        
        echo "Checking backend .env file content (non-sensitive)..."
        echo "Backend .env file exists: $(test -f apps/backend/.env && echo 'YES' || echo 'NO')"
        echo "Backend .env file size: $(wc -c < apps/backend/.env) bytes"
        
        echo "Checking Google service account file..."
        echo "Google service account file exists: $(test -f apps/backend/config/google-service-account.json && echo 'YES' || echo 'NO')"
        echo "Google service account file size: $(wc -c < apps/backend/config/google-service-account.json) bytes"
        
        echo "Checking monitoring services status..."
        docker ps --filter "name=mentalspace-prometheus" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        docker ps --filter "name=mentalspace-grafana" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        docker ps --filter "name=mentalspace-node-exporter" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        echo "Monitoring services accessible at:"
        echo "- Prometheus: http://3.147.75.218:9090"
        echo "- Grafana: http://3.147.75.218:3000 (admin/admin123)"
        echo "- Node Exporter: http://3.147.75.218:9100"
        
        echo "Deployment completed!" 
